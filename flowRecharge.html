<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--360浏览器优先以webkit内核解析-->
    <title></title>
    <link rel="shortcut icon" href="favicon.ico">
    <link href="css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=4.1.0" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
</head>

<body class="frwrapper gray-bg">
    <form class="form-horizontal m-t col-sm-12" id="commentForm">
        <div class="col-sm-11 text-right">
            <ul class="list-inline">
                <li>
                    <a>
                        <input type="file" id="upfile">从文件导入</a>
                </li>
                <li>
                    <a href="download/uploadDemo.rar">模板下载</a></li>
            </ul>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">手 机 号 码：</label>
            <div class="col-sm-9">
                <textarea id="txtPhoneNum" name="comment" style="height: 100px;" class="form-control" required="" aria-required="true"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label"></label>
            <div class="col-sm-9">
                （注：多个手机号码之间必须用英文分号隔开，例如：“号码1;号码2;号码3”。）
                <label id="txtNumCount" style="color: red"></label>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">可选流量包：</label>
            <div class="col-sm-3">
                <select class="form-control m-b" id="selectYys" name="account">
                    <option>----请选择运营商----</option>
                </select>
            </div>
            <div class="col-sm-3 llbproducts">
                <select class="llboption option_first form-control m-b" name="account">
                    <option>----请选择流量包----</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label"></label>
            <div class="col-sm-5">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" class="checkbox" id="xyCheck" name="agree">同意XX协议
                    </label>
                    <a id="readMe">（阅读）</a>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label"></label>
            <div class="col-sm-3">
                <input type="button" class="btn btn-w-m btn-warning" id="flowPay" value="充值">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">说明：</label>
            <div class="col-sm-9">
                <p style="padding-top: 7px;">1、XXXXXXXXXXXXXXXXXXXXXXXXXX</p>
                <p>2、XXXXXXXXXXXXXXXXXXXXXXXXXX</p>
            </div>
        </div>
    </form>
    <div class="modal inmodal" id="duanxinModel" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel" style="text-align: left;">短信验证：</h4>
                </div>
                <div class="modal-body">
                    <div style="text-align: center;padding-bottom: 20px;">
                        <h4 style="padding: 20px;">手机号码：<span class="getcodephone"></span></h4>
                        <div style="display:inline-block;">
                            <input style="width:58%;float:left;" class="form-control" id="randomcode" placeholder="6位动态验证码" type="text" />
                            <input style="width:41%;float:right;" class="btn btn-primary" id="getrandomcode" type="button" value="获取验证码" />
                        </div>
                        <p style="padding-top: 10px;">请输入您手机收到的短信验证码后进行查询。</p>
                    </div>
                </div>
                <div class="modal-footer" style="text-align: center;">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" style="width: 30%;margin: 20px;" id="checkDuanxinCode">确 定</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 全局js -->
    <script src="js/jquery.min.js?v=2.1.4"></script>
    <script src="js/bootstrap.min.js?v=3.3.6"></script>
    <script src="js/plugins/layer/layer.min.js"></script>
    <script src="js/Base64.js"></script>
    <!-- 自定义js -->
    <script src="js/content.js"></script>
    <script>
    var ajaxUrl = "http://192.168.7.15:8089";
    $(document).ready(function() {
        //文件导入事件
        upFile();
        //检测手机号码数量和格式
        checkPhoneNum();
        //二级联动
        linkage();
        //阅读文件弹出层
        popupWindow();
        //获取全部产品类别并填入对应的选项
        setProducts();
        //获取验证码
        getCode();
        //充值
        flowPay();
    });

    //导入文件
    var upFile = function() {
        $("#upfile").change(function() {

            if (typeof(FileReader) == "undefined") {
                toastr.error("你的浏览器不支持文件读取");
                return;
            }

            var filePath = $("#upfile").val();
            if (filePath.split('.')[1].toLocaleLowerCase() != 'txt') {
                toastr.error("导入文件格式不正确");
                return;
            }

            $("#txtPhoneNum").val("正在导入号码，请稍后……");
            $("#txtPhoneNum").attr("Readonly", true);

            var file = document.getElementById("upfile").files[0];
            var reader = new FileReader();
            reader.readAsText(file);

            reader.onload = function(data) {

                var numphone = this.result.replace(/[\r\n]/g, ";").replace(/;;/g, ";").replace(/;;/g, ";");
                //alert(numphone);
                if (numphone.substring(0, 1) == ";") {
                    numphone = numphone.substring(1);
                }
                var reg = /^(1([0-9]{10})[;]{0,1})*$/;
                var re = new RegExp(reg);
                if (!re.test(numphone)) {
                    toastr.error("包含格式有误的手机号码或空行，请修正后重新导入。");
                    $("#txtPhoneNum").attr("Readonly", false);
                    $("#txtPhoneNum").val("");
                    return;
                }

                var resNum = numphone.split(';').length;

                if (numphone.split(';')[resNum - 1] == '') {
                    resNum = resNum - 1;
                }

                $("#txtNumCount").text("已导入" + resNum + "个号码");

                $("#txtPhoneNum").attr("Readonly", false);
                $("#txtPhoneNum").val(numphone);
            }
            $("#upfile").val("");
        });
    };
    //检测手机号码数量和格式
    var checkPhoneNum = function() {
        $("#txtPhoneNum").change(function() {
            var phoneResult = $("#txtPhoneNum").val();
            var numphone = phoneResult.replace(/[\r\n]/g, ";").replace(/;;/g, ";").replace(/;;/g, ";");
            //alert(numphone);
            if (numphone.substring(0, 1) == ";") {
                numphone = numphone.substring(1);
            }
            var reg = /^(1([0-9]{10})[;]{0,1})*$/;
            var re = new RegExp(reg);
            if (!re.test(numphone)) {
                layer.msg('包含格式有误的手机号码或空行，请修正后重新输入。');
                $("#txtPhoneNum").attr("Readonly", false);
                $("#txtPhoneNum").val("");
                $("#txtNumCount").text("");
                return;
            }

            var resNum = numphone.split(';').length;

            if (numphone.split(';')[resNum - 1] == '') {
                resNum = resNum - 1;
            }

            $("#txtNumCount").text("已导入" + resNum + "个号码");

            $("#txtPhoneNum").attr("Readonly", false);
            $("#txtPhoneNum").val(numphone);
        });
    };
    //二级联动
    var linkage = function() {
        $("#selectYys").change(function() {
            var index = $(this).get(0).selectedIndex;
            $('.llboption').hide().eq(index).show();
        });
    };
    //阅读协议弹出层
    var popupWindow = function() {
        $("#readMe").click(function() {
            layer.open({
                type: 2,
                title: "XX协议",
                skin: 'mybtn-class',
                maxmin: true, //开启最大化最小化按钮
                area: ['893px', '600px'],
                closeBtn: 1,
                content: 'xydocument.html',

                btnAlign: 'c',
                btn: ['同意', '拒绝'],
                yes: function(index) {
                    $("#xyCheck").prop("checked", "checked");
                    layer.close(index);
                },
                btn2: function(index) {
                    $("#xyCheck").removeAttr("checked");;
                    layer.close(index);
                }
            });
        });
    };
    //获取全部产品类型并写入对应选项
    var setProducts = function() {
        var yiDong = [],
            lianTong = [],
            dianXin = [];
        $.ajax({
            url: ajaxUrl + '/sas/query/getAllList',
            type: 'post',
            dataType: 'text',
            contentType: 'application/text;charset=UTF-8',
            success: function(data) {
                // 将返回的内容处理后进行base64解码并格式化为json格式
                var result = utf8to16(base64decode(data.replace(/\s/g, '')));
                result = JSON.parse(result);
                // 打印产品列表返回值
                // console.log(result);
                //成功获取到产品列表 code=200
                if (result.code == "200") {
                    // 将运营商按分类整理出对应数组
                    var productsLength = result.data.length;
                    for (var i = 0; i < productsLength; i++) {
                        if (result.data[i].productName.indexOf("移动") >= 0) {
                            yiDong.push(result.data[i]);
                        } else if (result.data[i].productName.indexOf("联通") >= 0) {
                            lianTong.push(result.data[i]);
                        } else if (result.data[i].productName.indexOf("电信") >= 0) {
                            dianXin.push(result.data[i]);
                        };
                    };
                    //获取需要填充元素的Dom节点
                    var $selectYys = $("#selectYys");
                    var $llbProducts = $(".llbproducts");
                    //如果移动运营商的数组长度不为0 则将移动填入一级联动选项中 移动下属的流量包套餐填入二级联通选项中
                    if (yiDong.length != 0) {
                        $('<option>').html("移动").appendTo($selectYys);
                        var $ydSelectBox = $('<select>').addClass('llboption form-control m-b').appendTo($llbProducts);
                        $('<option>').html("----请选择流量包----").appendTo($ydSelectBox);
                        var yiDongProductsLen = yiDong.length;
                        for (var i = 0; i < yiDongProductsLen; i++) {
                            var price = yiDong[i].price / 100;
                            $('<option>').html(yiDong[i].productName + " " + price + "元").attr("value", yiDong[i].productNo).appendTo($ydSelectBox);
                        };
                    };
                    //如果联通运营商的数组长度不为0 则将联通填入一级联动选项中 联通下属的流量包套餐填入二级联通选项中
                    if (lianTong.length != 0) {
                        $('<option>').html("联通").appendTo($selectYys);
                        var $ltSelectBox = $('<select>').addClass('llboption form-control m-b').appendTo($llbProducts);
                        $('<option>').html("----请选择流量包----").appendTo($ltSelectBox);
                        var lianTongProductsLen = lianTong.length;
                        for (var i = 0; i < lianTongProductsLen; i++) {
                            var price = lianTong[i].price / 100;
                            $('<option>').html(lianTong[i].productName + " " + price + "元").attr("value", lianTong[i].productNo).appendTo($ltSelectBox);
                        };
                    };
                    //如果电信运营商的数组长度不为0 则将电信填入一级联动选项中 电信下属的流量包套餐填入二级联通选项中
                    if (dianXin.length != 0) {
                        $('<option>').html("电信").appendTo($selectYys);
                        var $dxSelectBox = $('<select>').addClass('llboption form-control m-b').appendTo($llbProducts);
                        $('<option>').html("----请选择流量包----").appendTo($dxSelectBox);
                        var dianXinProductsLen = dianXin.length;
                        for (var i = 0; i < dianXinProductsLen; i++) {
                            var price = dianXin[i].price / 100;
                            $('<option>').html(dianXin[i].productName + " " + price + "元").attr("value", dianXin[i].productNo).appendTo($dxSelectBox);
                        };
                    };
                } else {
                    layer.msg("服务器异常，请稍后手动刷新页面");
                };
            },
            error: function(err) {
                // console.log(err);
            }
        });
    };
    //获取短信验证码
    var getCode = function() {
        $("#getrandomcode").click(function() {
            var sendPhoneVal = $(".getcodephone").text();
            //存储参数串
            var data = JSON.stringify({
                'userAccount': window.sessionStorage.userAccount,
                'phone': sendPhoneVal
            });

            //对参数串进行base64加密
            var dataValue = base64encode(utf16to8(data));

            //发起获取验证码请求
            $.ajax({
                url: ajaxUrl + '/sas/phone/sendMessage?ecode=' + dataValue,
                type: 'post',
                dataType: 'text',
                contentType: 'application/text;charset=UTF-8',
                success: function(data) {
                    // 将返回值处理后进行base64解码并格式化为json格式
                    var result = utf8to16(base64decode(data.replace(/\s/g, '')));
                    result = JSON.parse(result);
                    // console.log(result);
                    // 如果返回值信息为成功 提示发送消息并禁用获取按钮开始倒计时
                    if (result.msg == "success") {

                        layer.msg("验证码已发送，请注意查收", { icon: 1 });

                        var setTime;
                        var time = 60;
                        setTime = setInterval(function() {
                            if (time <= 0) {
                                clearInterval(setTime);
                                $("#getrandomcode").attr("disabled", false);
                                $("#getrandomcode").val("获取验证码");
                                return;
                            }
                            time--;
                            $("#getrandomcode").val(time + "s后重新获取");
                            $("#getrandomcode").attr("disabled", true);
                        }, 1000);
                    } else {
                        layer.msg("验证码发送失败，请重新获取", { icon: 2 });
                    };
                },
                error: function(err) {
                    // console.log(err);
                }
            });
        });
    }
    //充值
    var flowPay = function() {
        var phoneNum;
        var productNo;
        $("#flowPay").click(function() {
            //验证手机号码区域是否为空

            if ($("#txtPhoneNum").val() == "" || $("#txtPhoneNum").val().length == "0") {
                layer.msg('手机号码不能为空');
                return false;
            } else {
                phoneNum = $("#txtPhoneNum").val();
            };

            //验证用户是否勾选流量包
            var llboptionLen = $(".llboption").length;
            for (var i = 0; i < llboptionLen; i++) {
                $(".llboption").eq(i).css("display");
                if ($(".llboption").eq(i).css("display") == "inline-block") {
                    if ($(".llboption").eq(i).val() == "----请选择流量包----") {
                        layer.msg('请选择流量包');
                        return false;
                    } else {
                        productNo = $(".llboption").eq(i).val();
                    }
                };
            };

            //验证用户是否勾选协议
            if (!$("#xyCheck").is(':checked')) {
                layer.msg('请同意XX协议！');
                return false;
            };

            //充值页面输入选项都没有问题的情况下 打开短信验证模态框
            $('#duanxinModel').modal("show");

            //给短信验证模态框电话赋值
            $(".getcodephone").html(window.sessionStorage.spMobile);


        });

        //点击模态框确认按钮 发起充值请求
        $("#checkDuanxinCode").click(function() {
            //验证短信验证码
            var regNumber = /^\d{6}$/;
            var duanxinCodeVal;
            if ($("#randomcode").val() == "" || $("#randomcode").val().length == "0") {
                layer.tips('短信验证码不能为空！', '#randomcode', {
                    tips: [1, '#78BA32']
                });
                return false;
            };
            if (!regNumber.test($("#randomcode").val())) {
                layer.tips('验证码格式错误！', '#randomcode', {
                    tips: [1, '#78BA32']
                });
                return false;
            };
            duanxinCodeVal = $("#randomcode").val();
            //声明空数组 用于存放下单结果
            var flowPayResult = [];
            //处理用户提交的充值电话信息 遍历发送请求
            var phoneArr = phoneNum.split(";");
            //数组去重
            var uniquePhoneArr = phoneArr.unique();
            //去重数组中的空字符串
            var trimSpacePhoneArr = trimSpace(uniquePhoneArr);
            var phoneArrLen = trimSpacePhoneArr.length;
            //声明随机串用于识别订单批次 格式为yyyymmddhhmmss+6位数字字母组合随机数
            var nowTime = new Date();
            var orderCode = format(nowTime, "yyyyMMddHHmmss") + '' + randomWord(false, 6);  
            for (var i = 0; i < phoneArrLen; i++) {
                var phone = trimSpacePhoneArr[i];
                if (phone.length !== 0) {
                    var data = JSON.stringify({
                        'outTradeNo': "",
                        'payCount': phoneArrLen,
                        'OrderCode': orderCode,
                        'phone': phone,
                        'productNo': productNo,
                        'userAccount': window.sessionStorage.userAccount,
                        'codes': duanxinCodeVal,
                        'carrier': window.sessionStorage.spMobile
                    });
                    var dataValue = base64encode(utf16to8(data));
                    //发起充值请求
                    $.ajax({
                        url: ajaxUrl + '/sas/pay/flowPay?ecode=' + dataValue,
                        type: 'post',
                        dataType: 'text',
                        async: false,
                        contentType: 'application/text;charset=UTF-8',
                        success: function(data) {
                            // 将返回的内容处理后进行base64解码并处理成json格式
                            var result = utf8to16(base64decode(data.replace(/\s/g, '')));
                            result = JSON.parse(result);
                            // console.log(result);
                            flowPayResult.push(result.msg);
                        },
                        error: function(err) {
                            // console.log(err);
                        }
                    });
                };
            };
            //充值后的提示信息
            // console.log(flowPayResult);
            var flowPayResFlag;
            var flowPayResultLen = flowPayResult.length;
            // console.log(flowPayResultLen);
            for (var i = 0; i < flowPayResultLen; i++) {
                var flowPayResVal = flowPayResult[i];
                // console.log(flowPayResVal);
                if (flowPayResVal == "下单成功") {
                    flowPayResFlag = true;
                    break;
                };
            };
            //如果有一单成功，则提示成功 如果都失败了 就提示失败
            if (flowPayResFlag == true) {
                layer.msg("下单成功，请稍后查询订单详情");
            } else {
                layer.msg("下单失败");
            };

            //清空验证码输入框
            $("#randomcode").val("");
            //调用父页面查询余额的方法
            window.parent.getBalance();
        });
    };
    //格式化日期
    var format = function(time, format) {
        var t = new Date(time);
        var tf = function(i) { return (i < 10 ? '0' : '') + i };
        return format.replace(/yyyy|MM|dd|HH|mm|ss/g, function(a) {
            switch (a) {
                case 'yyyy':
                    return tf(t.getFullYear());
                    break;
                case 'MM':
                    return tf(t.getMonth() + 1);
                    break;
                case 'mm':
                    return tf(t.getMinutes());
                    break;
                case 'dd':
                    return tf(t.getDate());
                    break;
                case 'HH':
                    return tf(t.getHours());
                    break;
                case 'ss':
                    return tf(t.getSeconds());
                    break;
            }
        })
    };
    //生成6位随机字符串
    /*
     ** randomWord 产生任意长度随机字母数字组合
     ** randomFlag-是否任意长度 min-任意长度最小位[固定位数] max-任意长度最大位
     */
    function randomWord(randomFlag, min, max) {
        var str = "",
            range = min,
            arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

        // 随机产生
        if (randomFlag) {
            range = Math.round(Math.random() * (max - min)) + min;
        }
        for (var i = 0; i < range; i++) {
            pos = Math.round(Math.random() * (arr.length - 1));
            str += arr[pos];
        }
        return str;
    };
    //数组去重
    Array.prototype.unique = function() {
        var res = [];
        var json = {};
        for (var i = 0; i < this.length; i++) {
            if (!json[this[i]]) {
                res.push(this[i]);
                json[this[i]] = 1;
            }
        }
        return res;
    };
    //去除数组中的空值  
    function trimSpace(array) {
        for (var i = 0; i < array.length; i++) {
            if (array[i] == "" || typeof(array[i]) == "undefined") {
                array.splice(i, 1);
                i = i - 1;
            }
        }
        return array;
    };
    </script>
</body>

</html>